var L=Object.defineProperty;var E=(i,t,e)=>t in i?L(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var a=(i,t,e)=>E(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=e(o);fetch(o.href,r)}})();const Y=50,v=3,S=.3,x=.2,d="rgba(0,0,0,0.2)",u="rgba(0,0,0,0.1)";class P{constructor(t){a(this,"ctx");this.ctx=t}}class X extends P{constructor(t){super(t)}draw(t,e){const s=e*Y,o=this.ctx.canvas.width,r=this.ctx.canvas.height;for(let n=t.x%s;n<o;n+=s){const l=Math.floor((n-t.x)/s+.5),h=Math.abs(l)%5===0?d:u;this.drawLine(n,0,n,r,h)}for(let n=t.x%s-s;n>=0;n-=s){const l=Math.floor((n-t.x)/s+.5),h=Math.abs(l)%5===0?d:u;this.drawLine(n,0,n,r,h)}for(let n=t.y%s;n<r;n+=s){const l=Math.floor((n-t.y)/s+.5),h=Math.abs(l)%5===0?d:u;this.drawLine(0,n,o,n,h)}for(let n=t.y%s-s;n>=0;n-=s){const l=Math.floor((n-t.y)/s+.5),h=Math.abs(l)%5===0?d:u;this.drawLine(0,n,o,n,h)}}drawLine(t,e,s,o,r){let n=this.ctx.strokeStyle;this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(s,o),this.ctx.strokeStyle=r,this.ctx.stroke(),this.ctx.strokeStyle=n}}const m="rgb(79,156,238)",b="rgba(79,156,238,0.1)";function p(i){let t={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return i.forEach(e=>{t.minX=Math.min(t.minX,e.x),t.minY=Math.min(t.minY,e.y),t.maxX=Math.max(t.maxX,e.x),t.maxY=Math.max(t.maxY,e.y)}),t}class f extends P{constructor(e,s,o){super(e);a(this,"points");a(this,"isClose");a(this,"isFill");a(this,"fillColor");a(this,"strokeColor");a(this,"isSelected",!1);a(this,"index",0);this.points=s,this.isClose=o.isClose||!1,this.isFill=o.isFill||!1,this.fillColor=o.fillColor||"rgb(255,255,255)",this.strokeColor=o.strokeColor||"rgb(0,0,0)"}isInArea(e,s,o,r){let n=!0;return this.points.map(l=>({x:o.x+l.x*r,y:o.y+l.y*r})).forEach(l=>{(l.x<Math.min(e.x,s.x)||l.x>Math.max(e.x,s.x)||l.y<Math.min(e.y,s.y)||l.y>Math.max(e.y,s.y))&&(n=!1)}),n}isPointInside(e,s,o){if(!this.isClose){let h=p(this.points);return s.x+h.minX*o<=e.x&&s.x+h.maxX*o>=e.x&&s.y+h.minY*o<=e.y&&s.y+h.maxY*o>=e.y}const r=this.points.map(h=>({x:s.x+h.x*o,y:s.y+h.y*o}));let n=!1;const l=r.length;for(let h=0,g=l-1;h<l;g=h++){const c=r[h],y=r[g];if(c.x===e.x&&c.y===e.y)return!0;const C=c.y>e.y!=y.y>e.y,A=e.x<(y.x-c.x)*(e.y-c.y)/(y.y-c.y)+c.x;C&&A&&(n=!n)}return n}select(){this.isSelected=!0}unselect(){this.isSelected=!1}draw(e,s){let o=this.points.map(r=>({x:e.x+r.x*s,y:e.y+r.y*s}));this.ctx.beginPath(),this.ctx.fillStyle=this.fillColor,this.ctx.strokeStyle=this.isSelected&&this.isClose?m:this.strokeColor,o.forEach((r,n)=>{n===0?this.ctx.moveTo(r.x,r.y):this.ctx.lineTo(r.x,r.y)}),this.isClose&&this.ctx.closePath(),this.isFill&&this.ctx.fill(),this.ctx.stroke(),this.isSelected&&!this.isClose&&this.drawBorder(o)}drawBorder(e){this.index=this.index++%23;let s=p(e);this.ctx.strokeStyle=m,this.ctx.strokeRect(s.minX,s.minY,s.maxX-s.minX,s.maxY-s.minY)}move(e,s){this.points=this.points.map(o=>(o.x+=e,o.y+=s,o))}}class O{}class w extends O{constructor(e,s,o){super();a(this,"shape");a(this,"offsetX");a(this,"offsetY");this.shape=e,this.offsetX=s,this.offsetY=o}execute(){this.shape.move(this.offsetX,this.offsetY)}undo(){this.shape.move(-this.offsetX,-this.offsetY)}}class T{constructor(t){a(this,"selectedShape");a(this,"commandManager");a(this,"totalOffsetX",0);a(this,"totalOffsetY",0);this.selectedShape=new Set,this.commandManager=t}singleSelect(t){this.clear(),this.selectedShape.has(t)||(this.selectedShape.add(t),t.select())}selectArea(t,e,s,o,r){s.forEach(n=>{n.isInArea(t,e,o,r)&&this.toggle(n)})}unselect(t){this.selectedShape.has(t)&&(this.selectedShape.delete(t),t.unselect())}toggle(t){this.selectedShape.has(t)?(this.selectedShape.delete(t),t.unselect()):(this.selectedShape.add(t),t.select())}clear(){this.selectedShape.forEach(t=>{t.unselect()}),this.selectedShape.clear()}has(t){return this.selectedShape.has(t)}beginMove(){this.totalOffsetX=0,this.totalOffsetY=0}move(t,e){if(!t&&!e)return;const s=[];this.selectedShape.forEach(o=>{s.push(new w(o,t,e))}),this.commandManager.execute(s,!1),this.totalOffsetX+=t,this.totalOffsetY+=e}stopMove(){if(!this.totalOffsetX&&!this.totalOffsetY)return;const t=[];this.selectedShape.forEach(e=>{t.push(new w(e,this.totalOffsetX,this.totalOffsetY))}),this.commandManager.push(t),this.totalOffsetX=0,this.totalOffsetY=0}singleShape(){return this.selectedShape.size<=1}}class _{constructor(){a(this,"history",[]);a(this,"redoStack",[])}push(t){this.history.push(t),this.redoStack.length=0}execute(t,e){for(const s of t)s.execute();e&&this.push(t)}undo(){const t=this.history.pop();if(t){for(let e=t.length-1;e>=0;e--)t[e].undo();this.redoStack.push(t)}}redo(){const t=this.redoStack.pop();if(t){for(const e of t)e.execute();this.history.push(t)}}}class M{constructor(t){a(this,"current",null);a(this,"tools",new Map);a(this,"prevForTempSwitch",null);a(this,"handlePointerDown",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onPointerDown)==null?void 0:s.call(e,t,this.ctx)});a(this,"handlePointerMove",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onPointerMove)==null?void 0:s.call(e,t,this.ctx)});a(this,"handlePointerUp",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onPointerUp)==null?void 0:s.call(e,t,this.ctx)});a(this,"handleWheel",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onWheel)==null?void 0:s.call(e,t,this.ctx)});a(this,"handleKeyDown",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onKeyDown)==null?void 0:s.call(e,t,this.ctx)});a(this,"handleKeyUp",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onKeyUp)==null?void 0:s.call(e,t,this.ctx)});this.ctx=t}register(t){this.tools.set(t.id,t)}setTool(t){var s,o,r;const e=this.tools.get(t);e&&((s=this.current)!=null&&s.onDeactivate&&this.current.onDeactivate(this.ctx),this.current=e,(r=(o=this.current).onActivate)==null||r.call(o,this.ctx),this.current.cursor&&(this.ctx.canvas.el.style.cursor=this.current.cursor))}tempSwitchTo(t){var s;const e=((s=this.current)==null?void 0:s.id)??null;e!==t&&(this.prevForTempSwitch=e,this.setTool(t))}restoreAfterTempSwitch(){this.prevForTempSwitch&&this.setTool(this.prevForTempSwitch),this.prevForTempSwitch=null}}class k extends f{constructor(e,s,o){super(e,[],o);a(this,"startPoint");a(this,"endPoint");this.startPoint=s,this.endPoint=s}setEndPoint(e){this.endPoint=e}isPointInside(e,s,o){return!1}draw(e,s){let o=this.startPoint,r=this.endPoint;o!==r&&(this.ctx.fillStyle=this.fillColor,this.ctx.fillRect(o.x,o.y,r.x-o.x,r.y-o.y))}}function D(i,t){const e=i.scale;t.deltaY>0?i.scale=Math.max(S,i.scale-x):i.scale=Math.min(v,i.scale+x),i.originPoint.x=(i.originPoint.x-t.offsetX)*i.scale/e+t.offsetX,i.originPoint.y=(i.originPoint.y-t.offsetY)*i.scale/e+t.offsetY}const I={id:"tool-select",cursor:"default",onActivate(i){},onPointerDown(i,t){const e=t.canvas,s={x:i.offsetX,y:i.offsetY},o=e.findShapeAt(s),r=i.shiftKey,n=i.ctrlKey||i.metaKey;if(r){e.selectArea=new k(e.ctx,s,{fillColor:b}),e._mode="area";return}o?(n?e.selectionManager.toggle(o):(e.selectionManager.singleShape()&&e.selectionManager.singleSelect(o),e.selectionManager.has(o)||e.selectionManager.singleSelect(o)),e._mode="drag",e._lastPt=s,e.selectionManager.beginMove()):i.button===0&&(e.selectionManager.clear(),e._mode="pan",e._lastPt=s)},onPointerMove(i,t){var o;const e=t.canvas,s=e._mode||"idle";if(s==="drag"){const r=e._lastPt,n=(i.offsetX-r.x)/e.scale,l=(i.offsetY-r.y)/e.scale;e.selectionManager.move(n,l),e._lastPt={x:i.offsetX,y:i.offsetY}}else if(s==="pan"){const r=e._lastPt;e.originPoint.x+=i.offsetX-r.x,e.originPoint.y+=i.offsetY-r.y,e._lastPt={x:i.offsetX,y:i.offsetY}}else s==="area"&&((o=e.selectArea)==null||o.setEndPoint({x:i.offsetX,y:i.offsetY}))},onPointerUp(i,t){var o;const e=t.canvas,s=e._mode||"idle";if(s==="drag")e.selectionManager.stopMove();else if(s==="area"){const r=((o=e.selectArea)==null?void 0:o.startPoint)||null,n={x:i.offsetX,y:i.offsetY};r&&e.selectionManager.selectArea(r,n,e.shapes,e.originPoint,e.scale),e.selectArea=null}e._mode="idle"},onWheel(i,t){i.preventDefault(),D(t.canvas,i)},onKeyDown(i,t){var r,n;const e=t.canvas;if(i.code==="Space"){t.setTool("tool-pan");return}if((i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="z"){e.commandManager.undo();return}if((i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="y"){(n=(r=e.commandManager).redo)==null||n.call(r);return}let s=0,o=0;switch(i.key){case"ArrowLeft":s=-1;break;case"ArrowRight":s=1;break;case"ArrowUp":o=-1;break;case"ArrowDown":o=1;break}(s||o)&&e.selectionManager.move(s,o)},onKeyUp(i,t){const e=t.canvas;["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(i.key)&&e.selectionManager.stopMove(),i.key==="Shift"&&(e.selectArea=null)}};function K(i,t){const e=i.scale;t.deltaY>0?i.scale=Math.max(S,i.scale-x):i.scale=Math.min(v,i.scale+x),i.originPoint.x=(i.originPoint.x-t.offsetX)*i.scale/e+t.offsetX,i.originPoint.y=(i.originPoint.y-t.offsetY)*i.scale/e+t.offsetY}const R={id:"tool-pan",cursor:"grab",onActivate(i){i.canvas.el.style.cursor="grab"},onPointerDown(i,t){i.button===0&&(t.canvas._panLast={x:i.offsetX,y:i.offsetY},t.canvas.el.style.cursor="grabbing")},onPointerMove(i,t){const e=t.canvas._panLast;e&&(t.canvas.originPoint.x+=i.offsetX-e.x,t.canvas.originPoint.y+=i.offsetY-e.y,t.canvas._panLast={x:i.offsetX,y:i.offsetY})},onPointerUp(i,t){t.canvas._panLast=null,t.canvas.el.style.cursor="grab"},onWheel(i,t){i.preventDefault(),K(t.canvas,i)},onKeyUp(i,t){if(i.code==="Space"){t.setTool("tool-select");return}}};class F{constructor(t){a(this,"el");a(this,"ctx");a(this,"width",300);a(this,"height",150);a(this,"scale",1);a(this,"originPoint",{x:20,y:20});a(this,"toolManager");a(this,"shapes",[]);a(this,"selectArea");a(this,"grid");a(this,"selectionManager");a(this,"commandManager");if(t.el&&typeof t.el=="string"&&(this.el=document.querySelector(t.el)),this.el.getContext&&(this.ctx=this.el.getContext("2d")),isNaN(parseInt(t.width)))throw"width error";if(isNaN(parseInt(t.height)))throw"height error";this.width=t.width,this.height=t.height,this.grid=new X(this.ctx),this.ctx._height=this.height,this.ctx._width=this.width,this.selectArea=null,this.commandManager=new _,this.toolManager=new M(this.ctx),this.selectionManager=new T(this.commandManager),this.resize(this.height,this.width),this.addShape(new f(this.ctx,[{x:330,y:330},{x:770,y:330},{x:770,y:770},{x:330,y:770}],{isClose:!0,isFill:!0})),this.addShape(new f(this.ctx,[{x:330,y:330},{x:770,y:330},{x:770,y:770},{x:330,y:770}],{isClose:!0,isFill:!0})),this.addShape(new f(this.ctx,[{x:330,y:330},{x:770,y:330},{x:770,y:770},{x:330,y:770}],{isClose:!0,isFill:!0})),this.addShape(new f(this.ctx,[{x:330,y:330},{x:770,y:330},{x:770,y:770},{x:330,y:770}],{isClose:!0,isFill:!0})),this.addShape(new f(this.ctx,[{x:330,y:330},{x:221,y:330},{x:246,y:770},{x:445,y:123}],{isClose:!1,isFill:!1})),this.addShape(new f(this.ctx,[{x:100,y:100},{x:200,y:100},{x:200,y:0}],{isClose:!0,isFill:!0})),this.draw(),this.registerTools(),this.registerToolEvents()}registerTools(){this.toolManager=new M({canvas:this,setTool:t=>this.toolManager.setTool(t)}),this.toolManager.register(I),this.toolManager.register(R),this.toolManager.setTool("tool-select")}registerToolEvents(){this.el.addEventListener("pointerdown",this.toolManager.handlePointerDown,{passive:!1}),this.el.addEventListener("pointermove",this.toolManager.handlePointerMove,{passive:!1}),window.addEventListener("pointerup",this.toolManager.handlePointerUp,{passive:!1}),this.el.addEventListener("wheel",this.toolManager.handleWheel,{passive:!1}),document.addEventListener("keydown",this.toolManager.handleKeyDown,{passive:!1}),document.addEventListener("keyup",this.toolManager.handleKeyUp,{passive:!1}),this.el.oncontextmenu=()=>!1}dispose(){this.el.removeEventListener("pointerdown",this.toolManager.handlePointerDown),this.el.removeEventListener("pointermove",this.toolManager.handlePointerMove),window.removeEventListener("pointerup",this.toolManager.handlePointerUp),this.el.removeEventListener("wheel",this.toolManager.handleWheel),document.removeEventListener("keydown",this.toolManager.handleKeyDown),document.removeEventListener("keyup",this.toolManager.handleKeyUp)}findShapeAt(t){for(let e=this.shapes.length-1;e>=0;e--)if(this.shapes[e].isPointInside(t,this.originPoint,this.scale))return this.shapes[e];return null}draw(t=!0){const e=this.el.width,s=this.el.height;this.ctx.clearRect(0,0,e,s),this.grid.draw(this.originPoint,this.scale),this.shapes.forEach(o=>o.draw(this.originPoint,this.scale)),this.selectArea&&this.selectArea.draw(this.originPoint,this.scale),requestAnimationFrame(()=>this.draw(t))}addShape(t){this.shapes.push(t)}resize(t,e){this.el.width=e,this.el.height=t}}let U=new F({el:"#canvas",width:window.innerWidth,height:window.innerHeight});console.log(U);
