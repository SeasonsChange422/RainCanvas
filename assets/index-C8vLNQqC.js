var L=Object.defineProperty;var Y=(i,t,e)=>t in i?L(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var n=(i,t,e)=>Y(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=e(r);fetch(r.href,a)}})();const O=50,v=3,C=.3,g=.2,u="rgba(0,0,0,0.2)",p="rgba(0,0,0,0.1)";class P{constructor(t){n(this,"ctx");n(this,"id","-1");this.ctx=t,this.generalId()}generalId(){this.id="id-"+new Date().getTime().toString(36)+"-"+Math.random().toString(36).substring(2,9)}}class X extends P{constructor(t){super(t)}draw(t,e){const s=e*O,r=this.ctx.canvas.width,a=this.ctx.canvas.height;for(let o=t.x%s;o<r;o+=s){const h=Math.floor((o-t.x)/s+.5),l=Math.abs(h)%5===0?u:p;this.drawLine(o,0,o,a,l)}for(let o=t.x%s-s;o>=0;o-=s){const h=Math.floor((o-t.x)/s+.5),l=Math.abs(h)%5===0?u:p;this.drawLine(o,0,o,a,l)}for(let o=t.y%s;o<a;o+=s){const h=Math.floor((o-t.y)/s+.5),l=Math.abs(h)%5===0?u:p;this.drawLine(0,o,r,o,l)}for(let o=t.y%s-s;o>=0;o-=s){const h=Math.floor((o-t.y)/s+.5),l=Math.abs(h)%5===0?u:p;this.drawLine(0,o,r,o,l)}}drawLine(t,e,s,r,a){let o=this.ctx.strokeStyle;this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(s,r),this.ctx.strokeStyle=a,this.ctx.stroke(),this.ctx.strokeStyle=o}}const M="rgb(79,156,238)",D="rgba(79,156,238,0.1)";function w(i){let t={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return i.forEach(e=>{t.minX=Math.min(t.minX,e.x),t.minY=Math.min(t.minY,e.y),t.maxX=Math.max(t.maxX,e.x),t.maxY=Math.max(t.maxY,e.y)}),t}class d extends P{constructor(e,s,r){super(e);n(this,"points");n(this,"isClose");n(this,"isFill");n(this,"fillColor");n(this,"strokeColor");n(this,"isSelected",!1);n(this,"index",0);this.points=s,this.isClose=r.isClose||!1,this.isFill=r.isFill||!1,this.fillColor=r.fillColor||"rgb(255,255,255)",this.strokeColor=r.strokeColor||"rgb(0,0,0)"}isInArea(e,s,r,a){let o=!0;return this.points.map(h=>({x:r.x+h.x*a,y:r.y+h.y*a})).forEach(h=>{(h.x<Math.min(e.x,s.x)||h.x>Math.max(e.x,s.x)||h.y<Math.min(e.y,s.y)||h.y>Math.max(e.y,s.y))&&(o=!1)}),o}isPointInside(e,s,r){if(!this.isClose){let l=w(this.points);return s.x+l.minX*r<=e.x&&s.x+l.maxX*r>=e.x&&s.y+l.minY*r<=e.y&&s.y+l.maxY*r>=e.y}const a=this.points.map(l=>({x:s.x+l.x*r,y:s.y+l.y*r}));let o=!1;const h=a.length;for(let l=0,m=h-1;l<h;m=l++){const c=a[l],x=a[m];if(c.x===e.x&&c.y===e.y)return!0;const A=c.y>e.y!=x.y>e.y,E=e.x<(x.x-c.x)*(e.y-c.y)/(x.y-c.y)+c.x;A&&E&&(o=!o)}return o}select(){this.isSelected=!0}unselect(){this.isSelected=!1}draw(e,s){let r=this.points.map(a=>({x:e.x+a.x*s,y:e.y+a.y*s}));this.ctx.beginPath(),this.ctx.fillStyle=this.fillColor,this.ctx.strokeStyle=this.isSelected&&this.isClose?M:this.strokeColor,r.forEach((a,o)=>{o===0?this.ctx.moveTo(a.x,a.y):this.ctx.lineTo(a.x,a.y)}),this.isClose&&this.ctx.closePath(),this.isFill&&this.ctx.fill(),this.ctx.stroke(),this.isSelected&&!this.isClose&&this.drawBorder(r)}drawBorder(e){this.index=this.index++%23;let s=w(e);this.ctx.strokeStyle=M,this.ctx.strokeRect(s.minX,s.minY,s.maxX-s.minX,s.maxY-s.minY)}move(e,s){this.points=this.points.map(r=>(r.x+=e,r.y+=s,r))}}class y{}class S extends y{constructor(e,s,r){super();n(this,"shape");n(this,"offsetX");n(this,"offsetY");this.shape=e,this.offsetX=s,this.offsetY=r}execute(){this.shape.move(this.offsetX,this.offsetY)}undo(){this.shape.move(-this.offsetX,-this.offsetY)}}class T extends y{constructor(e,s,r){super();n(this,"shapeManager");n(this,"index");n(this,"shape");this.shapeManager=e,this.index=s,this.shape=r}execute(){this.shapeManager.deleteShape(this.index)}undo(){this.shapeManager.undelete(this.index,this.shape)}}function f(i,t=new WeakMap){if(i===null||typeof i!="object")return i;if(t.has(i))return t.get(i);const e=Object.prototype.toString.call(i).slice(8,-1);let s;switch(e){case"Date":return new Date(i);case"RegExp":return new RegExp(i);case"Set":return s=new Set,t.set(i,s),i.forEach(r=>s.add(f(r,t))),s;case"Map":return s=new Map,t.set(i,s),i.forEach((r,a)=>s.set(a,f(r,t))),s;case"Symbol":return Symbol(i.description);case"Function":return i.bind({});case"Array":return s=[],t.set(i,s),i.forEach((r,a)=>s[a]=f(r,t)),s;case"CanvasRenderingContext2D":return i;default:return s=Object.create(Object.getPrototypeOf(i)),t.set(i,s),Reflect.ownKeys(i).forEach(r=>{s[r]=f(i[r],t)}),s}}class k extends y{constructor(e){super();n(this,"shapeManager");n(this,"pastedShapes",[]);this.shapeManager=e}execute(){this.pastedShapes=this.shapeManager.copyShapes.map(e=>f(e)),this.pastedShapes.forEach(e=>{e.generalId(),e.move(50,50)}),this.shapeManager.paste(this.pastedShapes)}undo(){this.shapeManager.deleteShapes(this.pastedShapes)}}class _{constructor(t,e){n(this,"selectedShapes");n(this,"commandManager");n(this,"shapeManager");n(this,"totalOffsetX",0);n(this,"totalOffsetY",0);n(this,"selectedArea");this.selectedShapes=new Set,this.commandManager=t,this.shapeManager=e,this.selectedArea=null}singleSelect(t){this.clear(),this.selectedShapes.has(t)||(this.selectedShapes.add(t),t.select())}selectArea(t,e,s,r){this.shapeManager.shapes.forEach(a=>{a.isInArea(t,e,s,r)&&this.toggle(a)})}unselect(t){this.selectedShapes.has(t)&&(this.selectedShapes.delete(t),t.unselect())}toggle(t){this.selectedShapes.has(t)?(this.selectedShapes.delete(t),t.unselect()):(this.selectedShapes.add(t),t.select())}clear(){this.selectedShapes.forEach(t=>{t.unselect()}),this.selectedShapes.clear()}has(t){return this.selectedShapes.has(t)}beginMove(){this.totalOffsetX=0,this.totalOffsetY=0}move(t,e){if(!t&&!e)return;const s=[];this.selectedShapes.forEach(r=>{s.push(new S(r,t,e))}),this.commandManager.execute(s,!1),this.totalOffsetX+=t,this.totalOffsetY+=e}stopMove(){if(!this.totalOffsetX&&!this.totalOffsetY)return;const t=[];this.selectedShapes.forEach(e=>{t.push(new S(e,this.totalOffsetX,this.totalOffsetY))}),this.commandManager.push(t),this.totalOffsetX=0,this.totalOffsetY=0}singleShape(){return this.selectedShapes.size<=1}deleteShapes(){const t=this.shapeManager.indexDescArr(Array.from(this.selectedShapes));this.commandManager.execute(t.map(e=>new T(this.shapeManager,e,this.shapeManager.getShape(e))),!0)}copy(){this.shapeManager.copy(Array.from(this.selectedShapes).map(t=>f(t)))}paste(){this.commandManager.execute([new k(this.shapeManager)],!0)}draw(t,e){this.selectedArea&&this.selectedArea.draw(t,e)}}class K{constructor(){n(this,"history",[]);n(this,"redoStack",[])}push(t){this.history.push(t),this.redoStack.length=0}execute(t,e){for(const s of t)s.execute();e&&this.history.push(t)}undo(){const t=this.history.pop();t&&(t.forEach(e=>{e.undo()}),this.redoStack.push(t))}redo(){const t=this.redoStack.pop();if(t){for(const e of t)e.execute();this.history.push(t)}}}class I{constructor(t){n(this,"current",null);n(this,"tools",new Map);n(this,"prevForTempSwitch",null);n(this,"handlePointerDown",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onPointerDown)==null?void 0:s.call(e,t,this.ctx)});n(this,"handlePointerMove",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onPointerMove)==null?void 0:s.call(e,t,this.ctx)});n(this,"handlePointerUp",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onPointerUp)==null?void 0:s.call(e,t,this.ctx)});n(this,"handleWheel",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onWheel)==null?void 0:s.call(e,t,this.ctx)});n(this,"handleKeyDown",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onKeyDown)==null?void 0:s.call(e,t,this.ctx)});n(this,"handleKeyUp",t=>{var e,s;return(s=(e=this.current)==null?void 0:e.onKeyUp)==null?void 0:s.call(e,t,this.ctx)});this.ctx=t}register(t){this.tools.set(t.id,t)}setTool(t){var s,r,a;const e=this.tools.get(t);e&&((s=this.current)!=null&&s.onDeactivate&&this.current.onDeactivate(this.ctx),this.current=e,(a=(r=this.current).onActivate)==null||a.call(r,this.ctx),this.current.cursor&&(this.ctx.canvas.el.style.cursor=this.current.cursor))}tempSwitchTo(t){var s;const e=((s=this.current)==null?void 0:s.id)??null;e!==t&&(this.prevForTempSwitch=e,this.setTool(t))}restoreAfterTempSwitch(){this.prevForTempSwitch&&this.setTool(this.prevForTempSwitch),this.prevForTempSwitch=null}}class R extends d{constructor(e,s,r){super(e,[],r);n(this,"startPoint");n(this,"endPoint");this.startPoint=s,this.endPoint=s}setEndPoint(e){this.endPoint=e}isPointInside(e,s,r){return!1}draw(e,s){let r=this.startPoint,a=this.endPoint;r!==a&&(this.ctx.fillStyle=this.fillColor,this.ctx.fillRect(r.x,r.y,a.x-r.x,a.y-r.y))}}function b(i,t){const e=i.scale;t.deltaY>0?i.scale=Math.max(C,i.scale-g):i.scale=Math.min(v,i.scale+g),i.originPoint.x=(i.originPoint.x-t.offsetX)*i.scale/e+t.offsetX,i.originPoint.y=(i.originPoint.y-t.offsetY)*i.scale/e+t.offsetY}const F={id:"tool-select",cursor:"default",onActivate(i){},onPointerDown(i,t){const e=t.canvas,s={x:i.offsetX,y:i.offsetY},r=e.findShapeAt(s),a=i.shiftKey,o=i.ctrlKey||i.metaKey;if(a){e.selectionManager.selectedArea=new R(e.ctx,s,{fillColor:D}),e._mode="area";return}r?(o?e.selectionManager.toggle(r):(e.selectionManager.singleShape()&&e.selectionManager.singleSelect(r),e.selectionManager.has(r)||e.selectionManager.singleSelect(r)),e._mode="drag",e._lastPt=s,e.selectionManager.beginMove()):i.button===0&&(e.selectionManager.clear(),e._mode="pan",e._lastPt=s)},onPointerMove(i,t){var r;const e=t.canvas,s=e._mode||"idle";if(s==="drag"){const a=e._lastPt,o=(i.offsetX-a.x)/e.scale,h=(i.offsetY-a.y)/e.scale;e.selectionManager.move(o,h),e._lastPt={x:i.offsetX,y:i.offsetY}}else if(s==="pan"){const a=e._lastPt;e.originPoint.x+=i.offsetX-a.x,e.originPoint.y+=i.offsetY-a.y,e._lastPt={x:i.offsetX,y:i.offsetY}}else s==="area"&&((r=e.selectionManager.selectedArea)==null||r.setEndPoint({x:i.offsetX,y:i.offsetY}))},onPointerUp(i,t){var r;const e=t.canvas,s=e._mode||"idle";if(s==="drag")e.selectionManager.stopMove();else if(s==="area"){const a=((r=e.selectionManager.selectedArea)==null?void 0:r.startPoint)||null,o={x:i.offsetX,y:i.offsetY};a&&e.selectionManager.selectArea(a,o,e.originPoint,e.scale),e.selectionManager.selectedArea=null}e._mode="idle"},onWheel(i,t){i.preventDefault(),b(t.canvas,i)},onKeyDown(i,t){const e=t.canvas;switch(i.code){case"Space":{t.setTool("tool-pan");return}case"Delete":{e.selectionManager.deleteShapes();return}}if((i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="z"){e.commandManager.undo();return}if((i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="y"){e.commandManager.redo();return}if((i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="c"){e.selectionManager.copy();return}if((i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="v"){e.selectionManager.paste();return}let s=0,r=0;switch(i.key){case"ArrowLeft":s=-1;break;case"ArrowRight":s=1;break;case"ArrowUp":r=-1;break;case"ArrowDown":r=1;break}(s||r)&&e.selectionManager.move(s,r)},onKeyUp(i,t){const e=t.canvas;["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(i.key)&&e.selectionManager.stopMove(),i.key==="Shift"&&(e.selectionManager.selectedArea=null)}};function U(i,t){const e=i.scale;t.deltaY>0?i.scale=Math.max(C,i.scale-g):i.scale=Math.min(v,i.scale+g),i.originPoint.x=(i.originPoint.x-t.offsetX)*i.scale/e+t.offsetX,i.originPoint.y=(i.originPoint.y-t.offsetY)*i.scale/e+t.offsetY}const B={id:"tool-pan",cursor:"grab",onActivate(i){i.canvas.el.style.cursor="grab"},onPointerDown(i,t){i.button===0&&(t.canvas._panLast={x:i.offsetX,y:i.offsetY},t.canvas.el.style.cursor="grabbing")},onPointerMove(i,t){const e=t.canvas._panLast;e&&(t.canvas.originPoint.x+=i.offsetX-e.x,t.canvas.originPoint.y+=i.offsetY-e.y,t.canvas._panLast={x:i.offsetX,y:i.offsetY})},onPointerUp(i,t){t.canvas._panLast=null,t.canvas.el.style.cursor="grab"},onWheel(i,t){i.preventDefault(),U(t.canvas,i)},onKeyUp(i,t){if(i.code==="Space"){t.setTool("tool-select");return}}};class N{constructor(t){n(this,"shapes");n(this,"copyShapes");this.shapes=t,this.copyShapes=[]}deleteShapes(t){const e=new Set(t.map(s=>s.id));this.shapes=this.shapes.filter(s=>!e.has(s.id))}indexDescArr(t){return t.map(e=>this.shapes.indexOf(e)).sort((e,s)=>s-e)}deleteShape(t){this.shapes.splice(t,1)}undelete(t,e){this.shapes.splice(t,0,e)}getShape(t){return this.shapes[t]}copy(t){t.forEach(e=>{e.generalId()}),this.copyShapes=t}paste(t){t.forEach(e=>{e.unselect()}),this.shapes.unshift(...t)}findShapeAt(t,e,s){for(let r=this.shapes.length-1;r>=0;r--)if(this.shapes[r].isPointInside(t,e,s))return this.shapes[r];return null}draw(t,e){this.shapes.forEach(s=>s.draw(t,e))}}class W{constructor(t){n(this,"el");n(this,"ctx");n(this,"width",300);n(this,"height",150);n(this,"scale",1);n(this,"originPoint",{x:20,y:20});n(this,"grid");n(this,"toolManager");n(this,"shapeManager");n(this,"selectionManager");n(this,"commandManager");if(t.el&&typeof t.el=="string"&&(this.el=document.querySelector(t.el)),this.el.getContext)this.ctx=this.el.getContext("2d");else throw"canvas error";if(isNaN(parseInt(t.width)))throw"width error";if(isNaN(parseInt(t.height)))throw"height error";let e=[];e.push(new d(this.ctx,[{x:330,y:330},{x:770,y:330},{x:770,y:770},{x:330,y:770}],{isClose:!0,isFill:!0})),e.push(new d(this.ctx,[{x:330,y:330},{x:770,y:330},{x:770,y:770},{x:330,y:770}],{isClose:!0,isFill:!0})),e.push(new d(this.ctx,[{x:330,y:330},{x:770,y:330},{x:770,y:770},{x:330,y:770}],{isClose:!0,isFill:!0})),e.push(new d(this.ctx,[{x:330,y:330},{x:770,y:330},{x:770,y:770},{x:330,y:770}],{isClose:!0,isFill:!0})),e.push(new d(this.ctx,[{x:330,y:330},{x:221,y:330},{x:246,y:770},{x:445,y:123}],{isClose:!1,isFill:!1})),e.push(new d(this.ctx,[{x:100,y:100},{x:200,y:100},{x:200,y:0}],{isClose:!0,isFill:!0})),this.width=t.width,this.height=t.height,this.grid=new X(this.ctx),this.commandManager=new K,this.shapeManager=new N(e),this.toolManager=new I({canvas:this,setTool:s=>this.toolManager.setTool(s)}),this.selectionManager=new _(this.commandManager,this.shapeManager),this.resize(this.height,this.width),this.draw(),this.registerTools(),this.registerToolEvents()}registerTools(){this.toolManager.register(F),this.toolManager.register(B),this.toolManager.setTool("tool-select")}registerToolEvents(){this.el.addEventListener("pointerdown",this.toolManager.handlePointerDown,{passive:!1}),this.el.addEventListener("pointermove",this.toolManager.handlePointerMove,{passive:!1}),window.addEventListener("pointerup",this.toolManager.handlePointerUp,{passive:!1}),this.el.addEventListener("wheel",this.toolManager.handleWheel,{passive:!1}),document.addEventListener("keydown",this.toolManager.handleKeyDown,{passive:!1}),document.addEventListener("keyup",this.toolManager.handleKeyUp,{passive:!1}),this.el.oncontextmenu=()=>!1}dispose(){this.el.removeEventListener("pointerdown",this.toolManager.handlePointerDown),this.el.removeEventListener("pointermove",this.toolManager.handlePointerMove),window.removeEventListener("pointerup",this.toolManager.handlePointerUp),this.el.removeEventListener("wheel",this.toolManager.handleWheel),document.removeEventListener("keydown",this.toolManager.handleKeyDown),document.removeEventListener("keyup",this.toolManager.handleKeyUp)}findShapeAt(t){return this.shapeManager.findShapeAt(t,this.originPoint,this.scale)}draw(t=!0){const e=this.el.width,s=this.el.height;this.ctx.clearRect(0,0,e,s),this.grid.draw(this.originPoint,this.scale),this.shapeManager.draw(this.originPoint,this.scale),this.selectionManager.draw(this.originPoint,this.scale),requestAnimationFrame(()=>this.draw(t))}resize(t,e){this.el.width=e,this.el.height=t}}let z=new W({el:"#canvas",width:window.innerWidth,height:window.innerHeight});console.log(z);
